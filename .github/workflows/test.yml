name: Windows RDP with Chinese UI via SSH Tunnel (Dynamic User)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 355

    steps:
    # 步骤 1: 检出代码
    - name: Checkout Code
      uses: actions/checkout@v4

    # 步骤 2: 安装中文语言包并设为系统默认
    - name: Install Chinese Pack and Set as Default
      shell: powershell
      run: |
        Write-Host "Installing full Chinese language pack components..."
        Get-WindowsCapability -Online | Where-Object { $_.Name -like 'Language.*.zh-CN*' } | Add-WindowsCapability -Online
        
        Write-Host "Setting system-wide language settings to zh-CN..."
        Set-WinSystemLocale zh-CN
        Set-WinUserLanguageList zh-CN -Force
        Set-WinUILanguageOverride -Language zh-CN
        Set-WinHomeLocation -GeoId 45

    # 步骤 3: 从 Secrets 创建新用户并设置密码
    # 这是修改的核心步骤，现在用户名和密码都是动态的
    - name: Create New User from Secrets
      shell: powershell
      run: |
        # 从 secrets 获取用户名和密码
        $username = "${{ secrets.RDP_USERNAME }}"
        $password = ConvertTo-SecureString -AsPlainText "${{ secrets.RDP_PASSWORD }}" -Force
        
        # 检查用户名是否为空，增加健壮性
        if ([string]::IsNullOrWhiteSpace($username)) {
            Write-Error "RDP_USERNAME secret is not set or empty. Please configure it in your repository secrets."
            exit 1
        }
        
        Write-Host "Creating new local user: $username"
        New-LocalUser -Name $username -Password $password -FullName "Dynamic RDP User" -Description "RDP user with Chinese UI created from secrets"
        
        Write-Host "Adding $username to Administrators and Remote Desktop Users groups..."
        Add-LocalGroupMember -Group "Administrators" -Member $username
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
        
        Write-Host "User '$username' created successfully."

    # 步骤 4: 启用远程桌面 (RDP)
    - name: Enable Remote Desktop
      shell: powershell
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1

    # 步骤 5: 创建并配置 SSH 私钥文件
    - name: Create and Configure SSH Private Key
      shell: powershell
      env:
        SSH_PRIVATE_KEY_CONTENT: ${{ secrets.SSH_PRIVATE_KEY }}
      run: |
        if (-not (Test-Path -Path ".ssh")) {
            New-Item -ItemType Directory -Path ".ssh"
        }
        $keyPath = ".ssh\id_ed25519"
        Set-Content -Path $keyPath -Value $env:SSH_PRIVATE_KEY_CONTENT
        icacls.exe $keyPath /inheritance:r
        icacls.exe $keyPath /grant "$($env:USERNAME):R"

    # 步骤 6: 启动 SSH 反向隧道并保持会话活动
    - name: Start SSH Reverse Tunnel and Keep Alive
      shell: powershell
      run: |
        Write-Host "Starting SSH reverse tunnel in the background..."
        Start-Process -FilePath "ssh.exe" -WindowStyle Hidden -ArgumentList @(
            "-i", ".ssh\id_ed25519",
            "-p", "${{ secrets.SSH_PORT }}",
            "-fNR", "13389:localhost:3389",
            "-o", "StrictHostKeyChecking=no",
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
        )
        
        Write-Host "Tunnel process started. Keeping the workflow alive."
        Write-Host "You can now connect to your SSH server on port 13389 to access the RDP session."
        # 在日志中明确打印出需要使用的用户名
        Write-Host "Use username '${{ secrets.RDP_USERNAME }}' and the password from your RDP_PASSWORD secret."

        $runtimeSeconds = 21300
        for ($i = 0; $i -lt $runtimeSeconds; $i += 60) {
            Write-Host "Session active. Uptime: $($i/60) minutes."
            Start-Sleep -s 60
        }
        Write-Host "Nearing maximum runtime. Workflow will now complete."
